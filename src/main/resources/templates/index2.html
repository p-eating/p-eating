<!DOCTYPE html>
<!--[if lt IE 7]>
<html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>
<html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>
<html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js">
<!--<![endif]-->

<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>靠脸吃饭</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="shortcut icon" href="favicon.ico"/>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700,300' rel='stylesheet' type='text/css'/>

    <link rel="stylesheet" href="/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/css/animate.css"/>
    <link rel="stylesheet" href="/css/style.css"/>


    <!-- jQuery -->
    <script src="/js/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="/js/bootstrap.min.js"></script>
    <!-- Placeholder -->
    <script src="/js/jquery.placeholder.min.js"></script>
    <!-- Waypoints -->
    <script src="/js/jquery.waypoints.min.js"></script>
    <!-- Main JS -->
    <script src="/js/main.js"></script>


    <!-- Modernizr JS -->
    <script src="/js/modernizr-2.6.2.min.js"></script>
    <!-- FOR IE9 below -->
    <!--[if lt IE 9]>
    <script src="/js/respond.min.js"></script>
    <![endif]-->

    <script type="text/javascript" src="/js/jquery.facedetection.js"></script>


</head>

<body class="style-2">
<div class="container">
    <div class="row">
        <div class="col-md-12 text-center">
            <ul class="menu">
                <li>
                    <a href="/view/user/create">录入你的脸</a>
                </li>
                <li class="active">
                    <a href="/view/user/look">看看你是谁</a>
                </li>
            </ul>
        </div>
    </div>
    <div class="row">
        <div class="col-md-4 ">
            <form action="#" class="fh5co-form animate-box" data-animate-effect="fadeInLeft">
                <div class="form-group camera-content">
                    <div type="text" id="camera">
                        <video id="video" width="800" height="600"></video>
                    </div>

                    <canvas id='canvas' width='600' height='400'></canvas>
                    <canvas id='canvas2' style="display: none" width='600' height='400'></canvas>

                </div>
                <div class="form-group operation">
                    <input type="submit" id="clean" value="重拍" class="btn btn-primary comfirm-btn"/>
                </div>
            </form>
        </div>
        <div class="col-md-4 col-md-offset-4">
            <div class="tab-pane" id="profile">
                <h4>BaseInfo</h4>
                <p class="sm">
                    <grey>姓名.</grey>
                    | <span class="user-name">爱吃鬼</span>
                    <br/>
                    <grey>性别.</grey>
                    |<span class="user-gender">男</span>
                    <br/>
                </p>

                <h4>Contact</h4>
                <p class="sm">
                    <grey> 电话</grey>
                    - 18545102020
                    <br/>
                    <grey> 邮箱</grey>
                    - aichigui@chinaredstar.com
                    <br/>
                </p>
            </div>
        </div>
    </div>
</div>

<script>


    var dataBase64 = '';

    var video = document.getElementById('video'),
            canvas = document.getElementById('canvas'),
            canvas2 = document.getElementById('canvas2'),
            vendorUrl = window.URL || window.webkitURL;

    //媒体对象
    navigator.getMedia = navigator.getUserMedia ||
            navagator.webkitGetUserMedia ||
            navigator.mozGetUserMedia ||
            navigator.msGetUserMedia;
    navigator.getMedia({
        video: true, //使用摄像头对象
        audio: false  //不适用音频
    }, function(strem){
        video.src = vendorUrl.createObjectURL(strem);
        video.play();

        window.setTimeout(getpicture,1000);

    }, function(error) {
        //error.code
        console.log(error);
    });

    $('#clean').click(function () {
        reset();
        window.setTimeout(getpicture,1000);
    });


    function getpicture() {

        canvas2.getContext('2d').drawImage(video, 0, 0, 600, 400);

        $('#canvas2').faceDetection({
            complete: function (faces) {

                if (faces.length == 0) { //说明没有检测到人脸
                    // alert("无人脸")
                    console.log('无人脸');
                    window.setTimeout(getpicture,100);
                } else {

                    for (var i in faces) {
                        draw(faces[i].x, faces[i].y, faces[i].width, faces[i].height);
                        // var leftTop = [faces[i].x, faces[i].y];
                        //     drawRectangle(leftTop, faces[i].width, faces[i].height);
                    }
                    console.log("有人脸");
                    canvas.getContext('2d').drawImage(video, 0, 0, 200, 100);
                    var dataTmp = canvas.toDataURL('image/png');
                    dataBase64 = dataTmp.replace("data:image/png;base64,", "");
                    $.ajax({
                        type: "post",                      //请求类型
                        url: "/face/checkFace",           //URL
                        data: JSON.stringify({image:dataBase64}),   //传递的参数
                        contentType: "application/json",//返回的数据类型
                        success: function (data) {          //data就是返回的json类型的数据
                            if (data.code == 200) {
                                alert(data.dataMap.name);
                            } else {
                                alert(data.message);
                                reset();
                                window.setTimeout(getpicture,1000);
                            }
                        },
                        error: function (data) {
                            alert("请求失败");
                        }
                    });
                    console.log(dataBase64);
                }
            }
//            error: function (code, message) {
//                alert("complete回调函数出错")
//            }
        });
    }


    function reset() {
        canvas2.getContext('2d').clearRect(0,0,canvas2.width,canvas2.height);
        canvas.getContext('2d').clearRect(0,0,canvas.width,canvas.height);
        dataBase64 = '';
    }

</script>

</body>
</html>
